@using System.IO
@using System.Globalization
@using CsvHelper
@using CsvHelper.Configuration
@using System.ComponentModel.DataAnnotations;
@using Microsoft.AspNetCore.SignalR.Client
@inject HubConnection HubConnection
@inject GameStateContainer GameState


<EditForm Model="@CreateModel" OnValidSubmit="@HandleValidSubmit">
    <h3>Create Game</h3>

    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="card-pack-file" class="col-form-label">Card Pack</label>
        <div class="custom-file">
            <InputFile OnChange="OnCardsFileSelection" class="custom-file-input" accept=".csv" />
            <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
        </div>
    </div>

    <div class="form-group">
        <label for="create-username-text" class="col-form-label">Username</label>
        <InputText @bind-Value="CreateModel.Username" class="form-control" id="create-username-text" />
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
</EditForm>


@code {

    private class CreateForm
    {
        [Required]
        [StringLength(10, ErrorMessage = "Name is too long.")]
        public string Username { get; set; }

        public List<QuestionCard> Questions = new();

        public List<AnswerCard> Answers = new();
    }

    CreateForm CreateModel = new CreateForm();

    async Task OnCardsFileSelection(InputFileChangeEventArgs e)
    {
        var config = new CsvConfiguration(CultureInfo.InvariantCulture)
        {
            HasHeaderRecord = true,
            PrepareHeaderForMatch = args => args.Header.ToLower(),
        };

        using var csvReader = new CsvReader(
        new StreamReader(e.File.OpenReadStream()), config);

        await foreach (var card in csvReader.GetRecordsAsync<Card>())
        {
            if (card.Type == CardType.Question)
            {
                CreateModel.Questions.Add(new QuestionCard(card.Text, card.Pick));
            }
            if (card.Type == CardType.Answer)
            {
                CreateModel.Answers.Add(new AnswerCard(card.Text));
            }
        }
    }

    public bool IsConnected => HubConnection.State == HubConnectionState.Connected;

    private async Task HandleValidSubmit()
    {
        try
        {
            var response = await HubConnection.InvokeAsync<CreateGameResponse>(nameof(IGameServer.CreateGame), new CreateGameRequest { 
                QuestionCards = CreateModel.Questions, 
                AnswerCards = CreateModel.Answers
            });

            var players = await HubConnection.InvokeAsync<List<Player>>(nameof(IGameServer.JoinGame), response.GameCode, CreateModel.Username);

            GameState.JoinGame(response.GameCode, CreateModel.Username, players);
        }
        catch (Exception ex)
        {
            //TODO
        }
    }

    enum CardType { Question, Answer };
    record Card(string Text, CardType Type, int Pick);

}
